root@d026e9724:/var/www/UrlCampaignTracker# # Create a SQL script to fix the schema and restore data
cat > /tmp/restore_database.sql << EOF
-- Drop and recreate the schema
DROP SCHEMA IF EXISTS public CASCADE;
CREATE SCHEMA public;

-- Grant necessary permissions
GRANT ALL ON SCHEMA public TO neondb_owner;
GRANT ALL ON SCHEMA public TO public;

-- Create a temporary table structure to match current schema
CREATE TABLE campaigns (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    custom_path TEXT,
    redirect_method TEXT DEFAULT 'http_307',
    use_trafficstar BOOLEAN DEFAULT false,
    trafficstar_campaign_id INTEGER,
    multiplier NUMERIC DEFAULT 1.0,
    price_per_1000 NUMERIC DEFAULT 0.0,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    is_active BOOLEAN DEFAULT true,
    budget_update_time TEXT,
    min_pause_click_threshold INTEGER DEFAULT 5000,
    min_activate_click_threshold INTEGER DEFAULT 15000,
    high_spend_min_pause_click_threshold INTEGER DEFAULT 1000,
    high_spend_min_activate_click_threshold INTEGER DEFAULT 5000
);

-- Additional tables will be created by the restore process
EOF

# Add the restore file content
cat /var/www/versions/version_6/database.sql >> /tmp/restore_database.sql

# Execute the restoration script
PGPASSWORD=npg_U8evoXZz0WOB psql -U neondb_owner -h 78.46.85.93 -p 5432 -d neondb < /tmp/restore_database.sql
NOTICE:  drop cascades to 35 other objects
DETAIL:  drop cascades to type url_status
drop cascades to function check_auto_sync()
drop cascades to function check_bypass_click_protection()
drop cascades to function click_protection_enabled()
drop cascades to function end_auto_sync(integer)
drop cascades to function is_auto_sync()
drop cascades to function prevent_auto_click_updates()
drop cascades to function prevent_campaign_auto_click_updates()
drop cascades to function prevent_test_auto_clicks_updates()
drop cascades to function prevent_unauthorized_click_updates()
drop cascades to function protect_original_click_values()
drop cascades to function start_auto_sync()
drop cascades to function update_original_click_value(integer,integer)
drop cascades to function update_original_url_records_updated_at()
drop cascades to table api_error_logs
drop cascades to table campaign_click_records
drop cascades to table campaign_monitoring
drop cascades to table campaign_redirect_logs
drop cascades to table campaigns
drop cascades to table click_analytics
drop cascades to table click_protection_test
drop cascades to table gmail_campaign_assignments
drop cascades to table original_url_records
drop cascades to table protection_settings
drop cascades to table sessions
drop cascades to table sync_operations
drop cascades to table system_settings
drop cascades to table trafficstar_campaigns
drop cascades to table trafficstar_credentials
drop cascades to table url_click_logs
drop cascades to table url_click_records
drop cascades to table urls
drop cascades to table users
drop cascades to table youtube_api_logs
drop cascades to table youtube_url_records
DROP SCHEMA
CREATE SCHEMA
GRANT
GRANT
CREATE TABLE
SET
SET
SET
SET
SET
 set_config
------------

(1 row)

SET
SET
SET
SET
ALTER SCHEMA
COMMENT
CREATE TYPE
ALTER TYPE
CREATE FUNCTION
ALTER FUNCTION
CREATE FUNCTION
ALTER FUNCTION
CREATE FUNCTION
ALTER FUNCTION
CREATE FUNCTION
ALTER FUNCTION
CREATE FUNCTION
ALTER FUNCTION
CREATE FUNCTION
ALTER FUNCTION
CREATE FUNCTION
ALTER FUNCTION
CREATE FUNCTION
ALTER FUNCTION
CREATE FUNCTION
ALTER FUNCTION
CREATE FUNCTION
ALTER FUNCTION
CREATE FUNCTION
ALTER FUNCTION
CREATE FUNCTION
ALTER FUNCTION
CREATE FUNCTION
ALTER FUNCTION
CREATE FUNCTION
ALTER FUNCTION
CREATE FUNCTION
ALTER FUNCTION
SET
SET
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER SEQUENCE
ALTER SEQUENCE
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER SEQUENCE
ALTER SEQUENCE
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER SEQUENCE
ALTER SEQUENCE
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER SEQUENCE
ALTER SEQUENCE
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER SEQUENCE
ALTER SEQUENCE
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER SEQUENCE
ALTER SEQUENCE
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER SEQUENCE
ALTER SEQUENCE
ERROR:  relation "campaigns" already exists
ALTER TABLE
COMMENT
COMMENT
ERROR:  column "high_spend_pause_threshold" of relation "public.campaigns" does not exist
ERROR:  column "high_spend_activate_threshold" of relation "public.campaigns" does not exist
ERROR:  relation "campaigns_id_seq" already exists
ALTER SEQUENCE
ALTER SEQUENCE
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER SEQUENCE
ALTER SEQUENCE
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER SEQUENCE
ALTER SEQUENCE
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER SEQUENCE
ALTER SEQUENCE
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER SEQUENCE
ALTER SEQUENCE
CREATE TABLE
ALTER TABLE
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER SEQUENCE
ALTER SEQUENCE
CREATE TABLE
ALTER TABLE
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER SEQUENCE
ALTER SEQUENCE
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER SEQUENCE
ALTER SEQUENCE
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER SEQUENCE
ALTER SEQUENCE
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER SEQUENCE
ALTER SEQUENCE
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER SEQUENCE
ALTER SEQUENCE
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER SEQUENCE
ALTER SEQUENCE
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER SEQUENCE
ALTER SEQUENCE
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER SEQUENCE
ALTER SEQUENCE
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER SEQUENCE
ALTER SEQUENCE
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER SEQUENCE
ALTER SEQUENCE
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER SEQUENCE
ALTER SEQUENCE
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER SEQUENCE
ALTER SEQUENCE
CREATE TABLE
ALTER TABLE
CREATE SEQUENCE
ALTER SEQUENCE
ALTER SEQUENCE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
COPY 16
COPY 0
COPY 0
COPY 0
COPY 2795710
COPY 1
COPY 2800119
ERROR:  column "price_per_thousand" of relation "campaigns" does not exist
invalid command \N
invalid command \.
ERROR:  syntax error at or near "1"
LINE 1: 1 Traffic1 http_307 traffic1 2025-05-10 11:37:14.552 2025-05...
        ^
invalid command \.
COPY 4
COPY 0
COPY 230
COPY 1
COPY 0
COPY 0
COPY 0
COPY 0
COPY 3
COPY 4
COPY 0
COPY 1
COPY 0
COPY 0
COPY 0
COPY 231
COPY 1
COPY 7747
COPY 13
 setval
--------
     16
(1 row)

 setval
--------
      1
(1 row)

 setval
--------
      1
(1 row)

 setval
--------
      1
(1 row)

 setval
---------
 2795710
(1 row)

 setval
--------
      1
(1 row)

 setval
---------
 2800119
(1 row)

 setval
--------
      4
(1 row)

 setval
--------
   8710
(1 row)

 setval
--------
      4
(1 row)

 setval
--------
      2
(1 row)

 setval
--------
    230
(1 row)

 setval
--------
      1
(1 row)

 setval
--------
      1
(1 row)

 setval
--------
      1
(1 row)

 setval
--------
      3
(1 row)

 setval
--------
      4
(1 row)

 setval
--------
      1
(1 row)

 setval
--------
      1
(1 row)

 setval
--------
     33
(1 row)

 setval
--------
      1
(1 row)

 setval
--------
      1
(1 row)

 setval
--------
    231
(1 row)

 setval
--------
      3
(1 row)

 setval
--------
   7798
(1 row)

 setval
--------
     13
(1 row)

ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ERROR:  multiple primary keys for table "campaigns" are not allowed
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
CREATE INDEX
CREATE INDEX
CREATE INDEX
CREATE INDEX
CREATE INDEX
CREATE INDEX
ERROR:  column "traffic_sender_enabled" does not exist
CREATE INDEX
CREATE INDEX
CREATE INDEX
CREATE INDEX
CREATE INDEX
CREATE INDEX
CREATE INDEX
CREATE INDEX
CREATE TRIGGER
CREATE TRIGGER
CREATE TRIGGER
CREATE TRIGGER
CREATE TRIGGER
CREATE TRIGGER
CREATE TRIGGER
CREATE TRIGGER
CREATE TRIGGER
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ERROR:  insert or update on table "youtube_api_logs" violates foreign key constraint "youtube_api_logs_campaign_id_fkey"
DETAIL:  Key (campaign_id)=(1) is not present in table "campaigns".
ERROR:  insert or update on table "youtube_url_records" violates foreign key constraint "youtube_url_records_campaign_id_fkey"
DETAIL:  Key (campaign_id)=(1) is not present in table "campaigns".
REVOKE
GRANT
root@d026e9724:/var/www/UrlCampaignTracker#
